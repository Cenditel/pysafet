/*
* SAFET Sistema Automatizado para la Firma Electrónica y Estampado de Tiempo
* Copyright (C) 2008 VÃ­ctor Bravo (vbravo@cenditel.gob.ve), Antonio Araujo (aaraujo@cenditel.gob.ve
*
* CENDITEL Fundacion Centro Nacional de Desarrollo e Investigación en TecnologÃ­as Libres
*
* Este programa es software libre; Usted puede usarlo bajo los términos de la licencia de
* software GPL versión 2.0 de la Free Software Foundation.
*
* Este programa se distribuye con la esperanza de que sea útil, pero SI NINGUNA GARANTÍA;
* tampoco las implí­citas garantí­as de MERCANTILIDAD o ADECUACIÃ“N A UN PROPÓSITO PARTICULAR.
* Consulte la licencia GPL para más detalles. Usted debe recibir una copia de la GPL junto
* con este programa; si no, escriba a la Free Software Foundation Inc. 51 Franklin Street,
* 5º Piso, Boston, MA 02110-1301, USA.
*
*/

/****************************************************************************
**
** Copyright (C) 2004-2006 Trolltech ASA. All rights reserved.
**
** This file is part of the example classes of the Qt Toolkit.
**
** This file may be used under the terms of the GNU General Public
** License version 2.0 as published by the Free Software Foundation
** and appearing in the file LICENSE.GPL included in the packaging of
** this file.  Please review the following information to ensure GNU
** General Public Licensing requirements will be met:
** http://www.trolltech.com/products/qt/opensource.html
**
** If you are unsure which license is appropriate for your use, please
** review the following information:
** http://www.trolltech.com/products/qt/licensing.html or contact the
** sales department at sales@trolltech.com.
**
** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
**
****************************************************************************/

#include <QtGui>
#include <QToolButton>
#include <QMessageBox>
#include "SafetYAWL.h"
#include "getfilewidget.h"

GetFileWidget::GetFileWidget(const QString& t, QWidget *parent, bool istextparent )
    : CmdWidget(t, parent,istextparent)
{

    _showfilename = true;

    SYD << tr("...GetFileWidget::GetFileWidget....(1)");

}

GetFileWidget::~GetFileWidget() {

}


void GetFileWidget::setText(const QString &newText) {
    _currtext = newText;
}


void GetFileWidget::showDialog() {
/*    QString fileName;

   QString types = tr("Todos (*);;Archivos de Texto (*.txt)");

   if ( conf().contains("filter") ) {
       types = conf()["filter"].toString();
   }

    QString curdir = QDir::homePath()+ "/" + Safet::datadir;
    QString dialogtype = conf()["options"].toString();
    if (dialogtype.startsWith("open") || dialogtype.isEmpty() ) {
        fileName = QFileDialog::getOpenFileName(this,
                                                tr("Seleccione un archivo"),
                                                curdir,
                                                types);

    }
    else if ( dialogtype.startsWith("save") ) {

             fileName = QFileDialog::getSaveFileName(this,
                                                     tr("Seleccione un directorio y un nombre de archivo"),
                                                     QDir::homePath(),
                                                     types);
    }
    else if (dialogtype.startsWith("dir") ) {
             fileName = QFileDialog::getSaveFileName(this,
                                                     tr("Seleccione un Directorio"),
                                                     QDir::homePath());
   }
    else {
        SafetYAWL::streamlog << SafetLog::Error << tr("No se definió correctamente el atributo \"%1\" "
                                                      "de un campo \"filename\" "
                                                      "(campos posibles open,save,dir").arg(dialogtype);
    }

    if (!fileName.isEmpty()) {
        filecombo->setEditText(fileName);

         filecombo->setFocus( Qt::PopupFocusReason );
    }
*/
}



bool GetFileWidget::isValid(QString& value) {
     _currtext = value;
     QString optionsstr = conf()["options"].toString();
     if ( optionsstr.startsWith("save")) {
         return CmdWidget::isValid(value);
     }
     else {

        if ( !QFile::exists(value)) {
            return false;
        }
    }
    return true;
}

void GetFileWidget::buildWidget() {
    updateCombo();
//    mainLayout = new QHBoxLayout;
//    filecombo = new QComboBox;
//    filenamebutton = new QToolButton;
//    filenamebutton->setText( "...");
//    if (isTextParent()) {
//        okbutton = new QToolButton;
//        okbutton->setGeometry(0,0,30,36);
//        okbutton->setIcon(QIcon(":/yes.png"));
//        quitbutton = new QToolButton;
//        quitbutton->setText( "X");
//    }

//    filecombo->setEditable(true);
//    mainLayout->addWidget(filecombo);
//    QString mytip = tr("Campo de Selección de Archivo\nEscriba Ctrl+L para finalizar");
//    if ( conf().contains("validation")) {
//        QStringList mylist = conf()["validation"].toString().split("::");
//        if (mylist.count() > 1 ) {
//            QString usertip = mylist.at(1);
//            mytip = usertip;
//        }
//    }
//    _usertooltip = mytip;
//    filecombo->setToolTip(mytip);

//    mainLayout->addWidget( filenamebutton);
//    mainLayout->addWidget(quitbutton);
//    mainLayout->addWidget(okbutton);

////   setLayout(mainLayout);
//   if (isTextParent()) {
//       connect(quitbutton, SIGNAL(clicked()), _texteditparent, SLOT(cancelAndClose()) );
//       connect(okbutton, SIGNAL(clicked()), _texteditparent, SLOT(insertAndClose()) );
//   }

////    connect(filenamebutton, SIGNAL(clicked()), this, SLOT(showDialog()) );
//    updateCombo();
//    filecombo->setEditText("");


}

void GetFileWidget::setFocus ( Qt::FocusReason reason ) {
//     QWidget::setFocus ( reason );
//     filecombo->setFocus( reason);
     
     
}
void GetFileWidget::insertAndClose() {    
/*    if ( _texteditparent ) {
        if ( filecombo) {
            QString value = filecombo->currentText().simplified();
            _texteditparent->insertPlainText(value.toLatin1());
            _texteditparent->insertPlainText("\n");
        }
    }

    close();*/
}

void GetFileWidget::updateCombo() {

    SYD << tr("...GetFileWidget::updateCombo()....(1)");
    QStringList myoptions = conf()["options"].toString().split(",",QString::SkipEmptyParts);

    foreach(QString op, myoptions) {
        QString myfield = op.section("::",0,0).trimmed();
        if (myfield.compare("show",Qt::CaseSensitive) == 0) {
            QString myvalue = op.section("::",1,1).trimmed();
            if (myvalue.compare("id",Qt::CaseSensitive) == 0 ) {
                _showfilename = false;
                break;
            }
        }
    }

    QString mime = SafetYAWL::getConf()["Widgets/getfilewidget.*"];
        QStringList mimes  = mime.
                         split(SafetYAWL::LISTSEPARATORCHARACTER,QString::SkipEmptyParts);

        _options.clear();
        _wfids.clear();

//        SYD << tr("...GetFileWidget::updateCombo()....(1)...mimes.count():|%1|")
//               .arg(mimes.count());

        foreach(QString s, mimes) {            
            SafetYAWL *myconfigurator = new SafetYAWL(SafetYAWL::pathconf);

            if ( myconfigurator ) {

//                SYD << tr("...GetFileWidget...SafetYAWL::pathconf...:|%1|")
//                       .arg(SafetYAWL::pathconf);
                myconfigurator->openXML(s);
                myconfigurator->convertXMLtoObjects();
                SafetWorkflow *mywf = myconfigurator->getWorkflow();
                if ( mywf ) {
                    _wfids.append(mywf->id());
                    _options.append(s);
                }
                else {
                    SYD << tr("....GetFileWidget::updateCombo()...NO mywf...");
                    _options.append(s);
                }
                delete myconfigurator;
            }
            else {
                SYD << tr("....GetFileWidget::updateCombo()...NO myconfigurator...");
                _options.append(s);
            }
        }
        qDebug("....updateCombo...(2)...");


}

QString GetFileWidget::html() {

    updateCombo();



    QString result = QString("<select name=\"%1\" id=\"%1\">\n")
            .arg(caption());

    result += QLatin1String("<option value=\"\"></option>");
    int i = 0;
    foreach(QString s, options()){
        if (s.trimmed().isEmpty()) {
            continue;
        }
        QString newitem;
        if ( _showfilename ) {
            newitem = QString("<option value=\"%1\">%1</option>\n")
                    .arg(s);
        }
        else {
            newitem = QString("<option value=\"%2\">%1</option>\n")
                    .arg(i<_wfids.count()?_wfids.at(i):s)
                    .arg(s);
        }

        i++;
        result += newitem;
    }


    result += QLatin1String("</select>");
    SYD << tr("...GetFileWidget::html()...:|%1|")
           .arg(result);
    return result;

}

QString GetFileWidget::text() const {
        QString result = "";
        result = _currtext;
        return result;
}               
